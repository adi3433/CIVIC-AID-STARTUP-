<!-- AUTOGENERATED BY CLAUDE: date=2026-02-05 -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CivicAid Emergency Dispatch - AI-powered emergency call handling">
    <title>Emergency Dispatch AI | CivicAid</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ef4444;
            --primary-dark: #dc2626;
            --primary-glow: rgba(239, 68, 68, 0.3);
            --secondary: #25D366;
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-input: #1f2937;
            --text-light: #f8fafc;
            --text-muted: #9ca3af;
            --border: rgba(255, 255, 255, 0.1);
            --gradient-start: #ef4444;
            --gradient-end: #f97316;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            background-image:
                radial-gradient(ellipse at top, rgba(239, 68, 68, 0.1), transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(249, 115, 22, 0.1), transparent 50%);
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 30px;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo a {
            color: var(--text-light);
            text-decoration: none;
        }

        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            margin-left: 30px;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        /* Hero Section */
        .hero {
            text-align: center;
            margin-bottom: 30px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #fff, #fca5a5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* Dispatch Card */
        .dispatch-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Status Bar */
        .status-bar {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-text {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Conversation Area */
        .conversation {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 300px;
            max-height: 400px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message.assistant {
            background: var(--bg-input);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.system {
            background: rgba(255, 255, 255, 0.05);
            align-self: center;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-input);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-8px);
            }
        }

        /* Waveform */
        .waveform {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 40px;
            padding: 0 20px;
        }

        .waveform.active {
            display: flex;
        }

        .waveform-bar {
            width: 4px;
            background: var(--primary);
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        @keyframes wave {

            0%,
            100% {
                height: 10px;
            }

            50% {
                height: 30px;
            }
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border);
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .text-input {
            flex: 1;
            padding: 14px 18px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-input);
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .text-input::placeholder {
            color: var(--text-muted);
        }

        /* Buttons */
        .btn-call {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.2s;
        }

        .btn-call.start {
            background: linear-gradient(135deg, var(--secondary), #128C7E);
            box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
        }

        .btn-call.start:hover {
            transform: scale(1.05);
        }

        .btn-call.end {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: 0 4px 20px var(--primary-glow);
        }

        .btn-call.end:hover {
            transform: scale(1.05);
        }

        .btn-mic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-input);
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .btn-mic:hover {
            border-color: var(--primary);
        }

        .btn-mic.recording {
            background: var(--primary);
            border-color: var(--primary);
            animation: pulse 1s infinite;
        }

        .btn-send {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .btn-send:hover {
            transform: translateY(-2px);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Call Controls */
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }

        /* States */
        .idle-state,
        .connected-state,
        .ended-state {
            display: none;
        }

        .idle-state.active,
        .connected-state.active,
        .ended-state.active {
            display: block;
        }

        .idle-content {
            text-align: center;
            padding: 60px 20px;
        }

        .idle-content .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .idle-content h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .idle-content p {
            color: var(--text-muted);
            margin-bottom: 30px;
        }

        .ended-content {
            text-align: center;
            padding: 40px 20px;
        }

        .ended-content .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .btn-new-call {
            background: var(--bg-input);
            color: var(--text-light);
            border: 2px solid var(--border);
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-new-call:hover {
            border-color: var(--primary);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        @media (max-width: 640px) {
            h1 {
                font-size: 1.75rem;
            }

            .conversation {
                min-height: 250px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <span>üèõÔ∏è</span>
                <a href="landing.html">CivicAid</a>
            </div>
            <nav class="nav-links">
                <a href="landing.html">Home</a>
                <a href="bot_builder.html">Bot Builder</a>
            </nav>
        </header>

        <section class="hero">
            <span class="badge">üö® EMERGENCY AI</span>
            <h1>Emergency Dispatch</h1>
            <p class="subtitle">AI-powered emergency response with voice recognition</p>
        </section>

        <div class="dispatch-card">
            <!-- Status Bar -->
            <div class="status-bar">
                <span class="status-text" id="status-text">Ready</span>
                <span class="status-indicator">
                    <span class="status-dot"></span>
                    <span id="status-label">Online</span>
                </span>
            </div>

            <!-- Idle State -->
            <div class="idle-state active" id="idle-state">
                <div class="idle-content">
                    <div class="icon">üìû</div>
                    <h2>Start Emergency Call</h2>
                    <p>Press the button below to connect with our AI dispatcher</p>
                    <button class="btn-call start" onclick="initiateCall()">
                        üìû
                    </button>
                </div>
            </div>

            <!-- Connected State -->
            <div class="connected-state" id="connected-state">
                <div class="conversation" id="conversation"></div>

                <div class="waveform" id="waveform">
                    <div class="waveform-bar" style="animation-delay: 0s;"></div>
                    <div class="waveform-bar" style="animation-delay: 0.1s;"></div>
                    <div class="waveform-bar" style="animation-delay: 0.2s;"></div>
                    <div class="waveform-bar" style="animation-delay: 0.3s;"></div>
                    <div class="waveform-bar" style="animation-delay: 0.4s;"></div>
                    <div class="waveform-bar" style="animation-delay: 0.5s;"></div>
                    <div class="waveform-bar" style="animation-delay: 0.6s;"></div>
                    <div class="waveform-bar" style="animation-delay: 0.7s;"></div>
                </div>

                <div class="input-area">
                    <div class="input-row">
                        <button class="btn-mic" id="mic-btn" onclick="toggleRecording()">üé§</button>
                        <input type="text" class="text-input" id="text-input" placeholder="Type your emergency..."
                            onkeypress="handleKeyPress(event)">
                        <button class="btn-send" id="send-btn" onclick="sendMessage()" disabled>‚û§</button>
                    </div>
                    <div class="call-controls" style="margin-top: 15px;">
                        <button class="btn-call end" onclick="endCall()">‚úï</button>
                    </div>
                </div>
            </div>

            <!-- Ended State -->
            <div class="ended-state" id="ended-state">
                <div class="ended-content">
                    <div class="icon">‚úÖ</div>
                    <h2>Call Ended</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Thank you for using CivicAid Emergency
                        Dispatch</p>
                    <button class="btn-new-call" onclick="resetCall()">Start New Call</button>
                </div>
            </div>
        </div>

        <footer>
            <p>Powered by CivicAid ‚Ä¢ AI Emergency Response</p>
        </footer>
    </div>

    <script>
        // State
        let callState = 'idle'; // idle, connecting, connected, ended
        let isRecording = false;
        let recognition = null;
        let conversationHistory = [];

        // DOM Elements
        const idleState = document.getElementById('idle-state');
        const connectedState = document.getElementById('connected-state');
        const endedState = document.getElementById('ended-state');
        const conversation = document.getElementById('conversation');
        const statusText = document.getElementById('status-text');
        const statusLabel = document.getElementById('status-label');
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const waveform = document.getElementById('waveform');

        // Initialize speech recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        textInput.value = finalTranscript;
                        sendBtn.disabled = false;
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                };

                recognition.onend = () => {
                    if (isRecording) {
                        try { recognition.start(); } catch (e) { }
                    }
                };
            }
        }

        // Toggle recording
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) {
                initSpeechRecognition();
            }
            if (recognition) {
                isRecording = true;
                micBtn.classList.add('recording');
                waveform.classList.add('active');
                try { recognition.start(); } catch (e) { }
            }
        }

        function stopRecording() {
            isRecording = false;
            micBtn.classList.remove('recording');
            waveform.classList.remove('active');
            if (recognition) {
                try { recognition.stop(); } catch (e) { }
            }
        }

        // Call functions
        function initiateCall() {
            callState = 'connecting';
            updateUI();

            statusText.textContent = 'Connecting...';
            statusLabel.textContent = 'Dialing';

            setTimeout(() => {
                callState = 'connected';
                updateUI();

                statusText.textContent = 'Connected';
                statusLabel.textContent = 'In Call';

                // Add initial greeting
                addMessage('assistant', "911 Emergency Dispatch. What's your emergency?");
                speakText("911 Emergency Dispatch. What's your emergency?");
            }, 2000);
        }

        function endCall() {
            stopRecording();
            callState = 'ended';
            updateUI();

            statusText.textContent = 'Call Ended';
            statusLabel.textContent = 'Offline';
        }

        function resetCall() {
            callState = 'idle';
            conversationHistory = [];
            conversation.innerHTML = '';
            textInput.value = '';
            sendBtn.disabled = true;
            updateUI();

            statusText.textContent = 'Ready';
            statusLabel.textContent = 'Online';
        }

        function updateUI() {
            idleState.classList.remove('active');
            connectedState.classList.remove('active');
            endedState.classList.remove('active');

            if (callState === 'idle' || callState === 'connecting') {
                idleState.classList.add('active');
            } else if (callState === 'connected') {
                connectedState.classList.add('active');
                textInput.focus();
            } else if (callState === 'ended') {
                endedState.classList.add('active');
            }
        }

        // Message functions
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
            conversationHistory.push({ role, content });
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing';
            typingDiv.innerHTML = `
                <span>Dispatch</span>
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            `;
            conversation.appendChild(typingDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        // Send message
        async function sendMessage() {
            const text = textInput.value.trim();
            if (!text) return;

            stopRecording();
            addMessage('user', text);
            textInput.value = '';
            sendBtn.disabled = true;

            showTyping();

            // Get AI response from backend
            try {
                const response = await getAIResponse(text);
                hideTyping();
                addMessage('assistant', response);
                speakText(response);
            } catch (error) {
                hideTyping();
                const fallbackResponse = getFallbackResponse(text, conversationHistory.length);
                addMessage('assistant', fallbackResponse);
                speakText(fallbackResponse);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Input validation
        textInput.addEventListener('input', () => {
            sendBtn.disabled = textInput.value.trim() === '';
        });

        // AI responses via Flask backend API
        async function getAIResponse(text) {
            const lowerText = text.toLowerCase();

            // Determine emergency type from text
            let emergencyType = 'default';
            if (lowerText.includes('fire') || lowerText.includes('burning') || lowerText.includes('smoke')) {
                emergencyType = 'fire';
            } else if (lowerText.includes('medical') || lowerText.includes('heart') || lowerText.includes('hurt') || lowerText.includes('bleeding') || lowerText.includes('unconscious')) {
                emergencyType = 'medical';
            } else if (lowerText.includes('robbery') || lowerText.includes('attack') || lowerText.includes('crime') || lowerText.includes('stolen') || lowerText.includes('thief')) {
                emergencyType = 'police';
            }

            try {
                // Call the n8n webhook directly (Static Frontend Mode)
                const response = await fetch('https://whiteknight001.app.n8n.cloud/webhook/dispatch-webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        call_id: `call_${Date.now()}`,
                        from: '+919876543210',
                        primary_busy: true,
                        metadata: {
                            emergency_type: emergencyType,
                            transcript: text,
                            region: 'kerala'
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    // Build response based on API result
                    const classification = data.classification || emergencyType;
                    const forwardTo = data.forward_to || '100';

                    // Generate appropriate dispatcher response based on classification and conversation stage
                    return generateDispatcherResponse(classification, text, conversationHistory.length);
                }
            } catch (error) {
                console.error('API Error:', error);
            }

            // Fallback to local responses if API fails
            return getFallbackResponse(text, conversationHistory.length);
        }

        // Generate contextual dispatcher responses
        function generateDispatcherResponse(classification, userText, messageCount) {
            const lowerText = userText.toLowerCase();

            // Check if user provided location info
            const hasLocation = lowerText.includes('street') || lowerText.includes('road') ||
                lowerText.includes('building') || lowerText.includes('apartment') ||
                lowerText.includes('house') || lowerText.includes('near') ||
                lowerText.includes('address') || /\d{6}/.test(userText) || // PIN code
                lowerText.includes('floor') || lowerText.includes('block');

            // Check if user confirmed safety or gave details
            const confirmedInfo = lowerText.includes('yes') || lowerText.includes('no') ||
                lowerText.includes('ok') || lowerText.includes('safe') ||
                lowerText.includes('people') || lowerText.includes('person');

            // Emergency-specific responses based on conversation stage
            if (classification === 'fire') {
                if (messageCount <= 2) {
                    return "Fire emergency confirmed. I'm dispatching fire services now. What is your exact address or location?";
                } else if (!hasLocation && messageCount <= 4) {
                    return "I need your exact location to send help. Please provide your address, nearby landmark, or building name.";
                } else if (hasLocation) {
                    return "Fire brigade is on the way to your location. ETA 5-7 minutes. Please evacuate the building if safe to do so. Are there any people trapped inside?";
                } else {
                    return "Help is being dispatched. Stay on the line. Move away from the fire and stay low if there's smoke. Is everyone accounted for?";
                }
            } else if (classification === 'medical') {
                if (messageCount <= 2) {
                    return "Medical emergency confirmed. Ambulance is being dispatched. What is your exact location?";
                } else if (!hasLocation && messageCount <= 4) {
                    return "Please provide your address so emergency services can reach you quickly.";
                } else if (hasLocation) {
                    return "Ambulance dispatched to your location. ETA 4-6 minutes. Is the person conscious and breathing? Keep them calm and still.";
                } else {
                    return "Medical team is on the way. Don't move the patient unless they're in immediate danger. Stay on the line.";
                }
            } else if (classification === 'police') {
                if (messageCount <= 2) {
                    return "Police are being notified. Are you in a safe location right now? What is your address?";
                } else if (!hasLocation && messageCount <= 4) {
                    return "I need your location to send officers. Where exactly are you?";
                } else if (hasLocation) {
                    return "Police officers dispatched to your location. ETA 3-5 minutes. Stay hidden if possible and don't confront anyone. Can you describe the suspect?";
                } else {
                    return "Officers are en route. Stay on the line and keep yourself safe. Do not engage with the perpetrator.";
                }
            }

            // Default/unknown emergency
            if (messageCount <= 2) {
                return "I understand you need help. Can you describe the nature of your emergency? Is it medical, fire, or a crime in progress?";
            } else if (hasLocation) {
                return "Thank you for the information. Emergency services are being dispatched to your location. Please stay on the line.";
            } else {
                return "To send help quickly, I need your exact address or a nearby landmark. What is your current location?";
            }
        }

        // Fallback when API unavailable
        function getFallbackResponse(text, messageCount) {
            const lowerText = text.toLowerCase();

            if (lowerText.includes('fire') || lowerText.includes('burning')) {
                return "Fire emergency noted. Fire brigade is being dispatched. What is your exact location?";
            } else if (lowerText.includes('medical') || lowerText.includes('heart') || lowerText.includes('hurt')) {
                return "Medical emergency. Ambulance is being dispatched. What is your location?";
            } else if (lowerText.includes('robbery') || lowerText.includes('attack') || lowerText.includes('crime')) {
                return "Police are being dispatched. Are you in a safe location?";
            } else if (lowerText.includes('street') || lowerText.includes('road') || lowerText.includes('building')) {
                return "Location received. Emergency services are on their way. ETA 5 minutes. Stay on the line.";
            } else if (messageCount > 3) {
                return "Help is on the way. Please stay calm and don't hang up until emergency services arrive.";
            } else {
                return "I understand. What type of emergency is this - medical, fire, or police? And what is your location?";
            }
        }

        // Text-to-speech
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Initialize
        initSpeechRecognition();
    </script>
</body>

</html>