# AUTOGENERATED BY CLAUDE: date=2026-02-05
# CivicAid OpenAPI Specification - Single Source of Truth

openapi: 3.0.3
info:
  title: CivicAid API
  description: Modular civic-tech platform API specification
  version: 1.0.0
  contact:
    name: CivicAid Team

servers:
  - url: http://localhost:5001
    description: WhatsApp Module (Adithyan)
  - url: http://localhost:5002
    description: Dispatch Module (Lestlin)
  - url: http://localhost:5003
    description: LeadGen Module (Lestlin)
  - url: http://localhost:5004
    description: Education Module (Basil)

paths:
  /whatsapp/generate:
    post:
      summary: Generate WhatsApp Bot Flow
      description: Creates a bot flow based on template with optional overrides
      operationId: generateWhatsAppBot
      tags:
        - WhatsApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WhatsAppGenerateRequest'
            example:
              template_id: phone_repair_basic
              overrides:
                prompt_model: "Which model is it?"
              dry_run: true
      responses:
        '200':
          description: Successfully generated bot flow
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WhatsAppGenerateResponse'
        '400':
          description: Missing required fields (template_id)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Unknown template_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /dispatch/webhook:
    post:
      summary: Handle Call Dispatch Webhook
      description: Receives incoming call data and determines routing action
      operationId: handleDispatchWebhook
      tags:
        - Dispatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DispatchWebhookRequest'
            example:
              call_id: "call_12345"
              from: "+919876543210"
              primary_busy: true
              metadata:
                region: "kerala"
                priority: "high"
      responses:
        '200':
          description: Dispatch action determined
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DispatchWebhookResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /leadgen/analyze:
    post:
      summary: Analyze Case and Generate Recommendations
      description: Uses RAG to analyze case text and provide structured next steps
      operationId: analyzeCase
      tags:
        - LeadGen
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeadGenAnalyzeRequest'
            example:
              case_text: "Vehicle theft reported near MG Road. Witness saw blue sedan."
              case_id: "CASE-2026-001"
      responses:
        '200':
          description: Analysis complete with recommendations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadGenAnalyzeResponse'
        '400':
          description: Missing case_text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /education/generate:
    post:
      summary: Generate Educational Presentation
      description: Creates a PPT/PDF presentation from structured content
      operationId: generatePresentation
      tags:
        - Education
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EducationGenerateRequest'
            example:
              title: "Civic Duties 101"
              slides:
                - heading: "Introduction"
                  bullets:
                    - "What is civic duty?"
                    - "Why it matters"
                - heading: "Voting Rights"
                  bullets:
                    - "Who can vote"
                    - "How to register"
      responses:
        '200':
          description: Presentation generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EducationGenerateResponse'
        '400':
          description: Invalid request structure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    # WhatsApp Module
    WhatsAppGenerateRequest:
      type: object
      required:
        - template_id
      properties:
        template_id:
          type: string
          description: ID of the template to use
        overrides:
          type: object
          additionalProperties:
            type: string
          description: Key-value pairs to override template defaults
        dry_run:
          type: boolean
          default: false
          description: If true, returns simulation without actual deployment

    WhatsAppGenerateResponse:
      type: object
      properties:
        bot_flow:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
            steps:
              type: array
              items:
                type: object
                properties:
                  step_id:
                    type: string
                  type:
                    type: string
                  content:
                    type: string
        simulation:
          type: array
          items:
            type: object
            properties:
              from:
                type: string
                enum: [bot, user]
              text:
                type: string

    # Dispatch Module
    DispatchWebhookRequest:
      type: object
      required:
        - call_id
        - from
        - primary_busy
      properties:
        call_id:
          type: string
        from:
          type: string
        primary_busy:
          type: boolean
        metadata:
          type: object
          additionalProperties: true

    DispatchWebhookResponse:
      type: object
      properties:
        action:
          type: string
          enum: [connect_primary, fallback_ai]
        classification:
          type: string
          description: Present when action is fallback_ai
        transcript:
          type: string
          description: Present when action is fallback_ai
        forward_to:
          type: string
          description: Present when action is fallback_ai

    # LeadGen Module
    LeadGenAnalyzeRequest:
      type: object
      required:
        - case_text
      properties:
        case_text:
          type: string
        case_id:
          type: string

    LeadGenAnalyzeResponse:
      type: object
      properties:
        case_id:
          type: string
        recommendations:
          type: array
          items:
            type: object
            properties:
              step:
                type: string
              confidence:
                type: number
                minimum: 0
                maximum: 1

    # Education Module
    EducationGenerateRequest:
      type: object
      required:
        - title
        - slides
      properties:
        title:
          type: string
        slides:
          type: array
          items:
            type: object
            required:
              - heading
              - bullets
            properties:
              heading:
                type: string
              bullets:
                type: array
                items:
                  type: string

    EducationGenerateResponse:
      type: object
      properties:
        artifact:
          type: string
          description: Filename of generated presentation
        note:
          type: string
          description: Additional notes about the generation

    # Common
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
